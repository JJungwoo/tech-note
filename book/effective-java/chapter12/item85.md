# 자바 직렬화의 대안을 찾으라

## 자바 직렬화의 위험성

- 직렬화는 근본적으로 지속적으로 계속 커지는 넓은 공격 범위 때문에 방어가 어렵다
  - 바이트 스트림을 역직렬화하는 과정에서 클래스 내부의 모든 코드를 수행할 수 있기에 클래스의 코드 전체가 공격 범위에 들어간다
- 자바의 표준 라이브러리나 아파치 커먼즈 컬렉션 같은 서드 파티 라이브러리는 물론 애플리케이션 자신의 클래스들도 공격 범위에 포함된다
  - 자바 라이브러리와 널리 쓰이는 서드 파티 라이브러리에서 직렬화 가능 타입들은 역직렬화 과정에 호출되어 잠재적으로 위험한 동작을 수행할 수 있는 메서드들이 있다
- 역직렬화 과정에 문제 상황 코드
  - 역직렬화 폭탄(deserialization bomb) <br>
  : 역직렬화 과정 시간이 오래 걸리는 짧은 스트림을 역직렬화하는 것만으로도 서비스 거부 공격에 쉽게 노출될 수 있다
  
  ```java
  static byte[] bomb() {
      Set<Object> root = new HashSet<>();
      Set<Object> s1 = root;
      Set<Object> s2 = new HashSet<>();

      for (int i=0; i < 100; i++) {
          Set<Object> t1 = new HashSet<>();
          Set<Object> t2 = new HashSet<>();

          t1.add("foo"); // t1을 t2과 다르게 만든다.
          s1.add(t1); s1.add(t2);
          s2.add(t1); s2.add(t2);

          s1 = t1; 
          s2 = t2;
      }
      return serialize(root);
  }
  ```
  위 예시 코드는 HashSet을 역직렬화 할 때 마다 hashCode 메서드를 2^100번 수행하게 되어 역직렬화하는데 매우 긴 시간이 걸리거나 그전에 스택이 터지게 된다
  
## 직렬화 위험을 대처하는 방법

**직렬화에서 발생하는 문제들에 대해 회피하는 가장 좋은 방법은 아무것도 역직렬화하지 않는 것이다.**

- 직렬화 대안 방법들
  - JSON, 프로토콜 버퍼
- 객체 역직렬화 필터링(java.io,ObjectInputFilter)을 사용하자
  - 객체 역직렬화 필터링을 통해 스트림이 역직렬화되기 전에 필터로 특정 클래스를 거부할 수 있다
- 블랙리스트 방식보다는 화이트리스트 방식을 추천한다

>화이트리스트(positive): 안전이 증명된 것만 허용하는 방법(정상적인 ip만 허용, 이외의 ip는 차단) <br>
>블랙리스트(nagative) : 악성 ip 목록만 차단하고 이외 모든 ip는 허용 

# 핵심 정리

- 직렬화는 위험하니 최대한 피해야한다(객체 역직렬화 필터링을 사용하자).
- 대안으로 JSON이나 프로토콜 버퍼를 사용하자.
- 신뢰할 수 있는 데이터만 역직렬화하자.

